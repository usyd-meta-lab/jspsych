<!DOCTYPE html>
<html>
<head>
  <title>USYD Metacognition</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Load jsPsych and jquery-->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.min.js'></script>
  <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/jquery-ui-css@1.11.5/jquery-ui.css" rel="stylesheet" type="text/css" />




  <!-- Load jsPsych plugins-->
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-external-html@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-external-html@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>

  <!-- Load the global environment-->
  <script src="global-env.js"></script>
  <script src="info_sheets.js"></script>
  

  <!-- Load custom plugins from directory-->
  <script src="staircase.js"></script>
  <script src="dot-difference-functions.js"></script>



  <!-- Some custom CSS-->
  <link href="custom-css.css" rel="stylesheet" type="text/css" />




  <style> 
    body {background-color: #A3A3A3;}
  </style>


</head>
<body></body>
<script>



/////////////// **********   IDS  ***************************** ///////////////



  const DataPipe_ID = "bjAI9yw63yXj"; // The DataPipe ID for where the data should be stored
  const sona_experiment_id = "NA"; // The SONA experiment ID 
  const sona_credit_token = "NA"; // The SONA credit token 
  const Prolific_redirect = "CHGWKNI0"; // The Prolific redirect link (to credit)
  const Prolific_failed_check = "C13PIUOF"; // The Prolific redirect link to NOT credit (manual review)



  const ratings_on = true;
  var trialnum = 1;
  var blocknum = 1;
  const task_time = 30; // time in minutes for the PIS 
  

  const staircase_on = true; // Turn on/off staircasing 
  const random_diff = false; // If true and the staircase is off then a spread of dots between 1 and 70 will be used
  
  var no_trials = 36; // number of trials in each block
  var no_practice_trials = 16; // number of trials in the practice block
  var total_blocks = 3; //note only updates instructions
  dots_diff = 4.25 // If staircase is on, then this is the log space starting difficulty. In log space, 4.25 is about 70 dots shown for the first trial. If staircase is off, then this is the fixed dot difference (not log space) for all trials when random_diff is false. If staircase is off and random_diff is true then this does nothing

  var in_fullscreen = true;
  aborted = false;
  phase = null;







/////////////// **********   INITALISE  ***************************** ///////////////


// Initalise jsPsych
  const jsPsych = initJsPsych({
   on_interaction_data_update: function(data) {
     if(data.event == 'fullscreenexit' & pilot != 'true'){in_fullscreen = false}

   },
 on_finish: function(data) {
   if(aborted == true){alert("You must use Chrome or Firefox to complete this experiment.")}
     if(aborted == false) {  if(jsPsych.data.get().filter({trial_type: "Summary Trial"}).select('correct').mean() < 0.55){window.location = attention_redirect_link} else {window.location = redirect_link}}

   }
})






/////////////// **********   INSTRUCTIONS  ***************************** ///////////////





  // Browser Check


  var browser_check = {
    timeline: [
      {  
        type: jsPsychBrowserCheck,
        inclusion_function: (data) => {
          return ['chrome', 'firefox'].includes(data.browser) && data.mobile === false;
        },
        exclusion_message: (data) => {
          aborted = true;
          if(data.mobile){
            return '<p>You must use a desktop/laptop computer to participate in this experiment.</p>';
          } else if(data.browser !== 'chrome'){
            return '<p>You must use Chrome or Firefox as your browser to complete this experiment.</p>'
          }
        },
      }
    ],
    conditional_function: function(){
      if(pilot === 'true'){
        return false;
      } else {
        return true;
      }
    }}



// Enter Fullscreen

    var enter_fullscreen = {
      timeline: [
        {type: jsPsychFullscreen,
          message: '<p>To take part in the experiment, your browser must be in fullscreen mode. Exiting fullscreen mode will pause the experiment. <br></br>Please click the button below to enable fullscreen mode and continue.</p>',
          fullscreen_mode: true,
          on_finish: function(){
            in_fullscreen = true;
          }
        }
      ],
      conditional_function: function(){
        if(pilot === 'true'){
          return false;
        } else {
          return true;
        }
      }
    }



// Debug
    var debug = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Did you experience any issues while completing this study?', rows: 5}
      ]
    }



// Instructions

    var stem_instructions = {
      type: jsPsychInstructions,
      pages: function(){
        return [
          '<p class="instructions">In this test, you will be presented with a few brief details about an emotional situation, and asked to choose from four responses the most effective course of action to manage both the emotions the person is feeling and the problems they face in that situation. </p>' +
          '<p class="instructions">Although more than one course of action might be acceptable, you are asked to choose what you think the most effective response for that person in that situation would be. </p>' +
          '<p class="instructions">Remember, you are not necessarily choosing what you would do, or the nicest thing to do, but choosing the most effective response for that situation. </p>' +
          '<p class="instructions">Please respond quickly and to the best of your ability.</p>',

        ]
      },
      show_clickable_nav: true
    }






    var conf_instruc = {
      timeline: [
        {
          type: jsPsychHtmlSliderResponse,
          css_classes: ["conf_instructions"],
          stimulus: function(){

            var header = jsPsych.timelineVariable('header')
            return '<div id = "header" style = "position: relative;">' +header + "</div><br><br>" +
            '<div id = "Iconf1" class = "conf_ins" style = "height: 25px; width: 154px; margin-top: 2px; margin-left: 15px;"></div>' +
            '<div id = "Iconf2" class = "conf_ins" style = "height: 25px; width: 154px; margin-top: 2px; margin-left: 169px;"></div>' +
            '<div id = "Iconf3" class = "conf_ins" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 323px;"></div>' +
            '<div id = "Iconf4" class = "conf_ins" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 477px;"></div>' +
            '<div id = "Iconf5" class = "conf_ins" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 631px;"></div>'
          },
          on_load: function(){

            var w = window.innerWidth;
            var marLeft = (w-800)/2;
            document.getElementById("Iconf1").style.left = marLeft + "px";
            document.getElementById("Iconf2").style.left = marLeft  + "px";
            document.getElementById("Iconf3").style.left = marLeft  + "px";
            document.getElementById("Iconf4").style.left = marLeft  + "px";
            document.getElementById("Iconf5").style.left = marLeft  + "px";

            var elementx = document.getElementById("jspsych-html-slider-response-response");
            elementx.disabled = jsPsych.timelineVariable('disable');


          },
          min: 1,
          max: 6,
          step: 1,
          slider_start: jsPsych.timelineVariable('start'),
          slider_width: 800,
          labels: ['Guessing', "", "", "", "", "Certain"],
          button_label: "Submit",
          require_movement: jsPsych.timelineVariable('require')
        }

      ],
      timeline_variables: [
        {start: 3, require: true, disable: false, header: 'A rating scale as shown below is used throughout the task. You will be able to rate your confidence of your judgements by choosing any point along the rating scale with your mouse. <br></br>Choose any point on the rating scale and click &apos;Submit&apos; to continue.'},
        {start: 6, require: false, disable: true, header: 'During the task, if you are <strong>very sure</strong> that you made the correct judgement, you should respond <strong>&apos;Certain&apos;</strong>'},
        {start: 1, require: false, disable: true, header: '<p class="instructions">If you are <strong>very unsure</strong> you made the correct judgement, you should respond <strong>&apos;Guessing&apos;</strong></p>'},
        {start: 4, require: true, disable: false, header: '<p class="instructions">If you are <strong>somewhat sure</strong> about being correct, you should select a rating between the two descriptions.</p>' +
        '<p class="instructions">If you understand how to use and take advantage of the whole rating scale, choose any point on the rating scale and click &apos;Submit&apos; to continue.</p>'}

      ],
      conditional_function: function(){
       if(ratings_on === true){
        return true;
      } else {
        return true;
      }
    }


  }





  var dd_instructions = {
    type: jsPsychInstructions,
    pages: function(){
      if(ratings_on == true) return [
        '<p class="instructions">In this task, we will ask you to judge which of two images contains more dots, before asking you to rate your confidence in your judgement.</p>' +
        '<p class="instructions">At the beginning of each trial, you will be presented with a black cross in the middle of the screen. Focus your attention on it. Then, two black boxes with a number of white dots will be flashed and you will be asked to judge which box had a higher number of dots.</p>' +
        '<p class="instructions">If the box on the <strong>left</strong> had more dots, <strong>press W</strong>.<br> If the box on the <strong>right</strong> had more dots, <strong> press E</strong>.</p>' +
        '<p class="instructions">Please respond quickly and to the best of your ability.</p>' +
        '<p class="instructions">You will then rate your confidence in your judgement on a scale with the mouse.</p>' +
        '<p class="instructions">Please do your best to rate your confidence accurately and do take advantage of the whole rating scale.</p>',
        '<p class="instructions">We will now ask you to carry out some practice trials. Please respond only when the dots have disappeared.</p>' +  
        '<p class="instructions">In this practice phase we will tell you whether your judgements are right or wrong. <br></br>If you are <strong>correct</strong>, the box that you selected will be outlined in <font color="green"><strong>green</strong></font>. <br>If you are <strong>incorrect</strong>, the box that you selected will be outlined in <font color="red"><strong>red</strong></font>.</p>' +
        '<p class="instructions">You will not need to rate your confidence of your judgements on these trials.</p>' 

      ]
      if(ratings_on == false) return [
        '<p class="instructions">Welcome to the task!</p>' +
        '<p class="instructions">In this task, we will ask you to judge which of two images contains more dots.</p>' +
        '<p class="instructions">At the beginning of each trial, you will be presented with a black cross in the middle of the screen. Focus your attention on it. Then, two black boxes with a number of white dots will be flashed and you will be asked to judge which box had a higher number of dots.</p>' +
        '<p class="instructions">If the box on the <strong>left</strong> had more dots, <strong>press W</strong>.<br> If the box on the <strong>right</strong> had more dots, <strong> press E</strong>.</p>' +
        '<p class="instructions">Please respond quickly and to the best of your ability.</p>',
        '<p class="instructions">We will now ask you to carry out some practice trials. Please respond only when the dots have disappeared.</p>' +  
        '<p class="instructions">In this practice phase we will tell you whether your judgements are right or wrong. <br></br>If you are <strong>correct</strong>, the box that you selected will be outlined in <font color="green"><strong>green</strong></font>. <br>If you are <strong>incorrect</strong>, the box that you selected will be outlined in <font color="red"><strong>red</strong></font>.</p>' 

      ]
    },
    show_clickable_nav: true
  }



  var practice_end = {
    type: jsPsychInstructions,

    pages:  function(){
     if(ratings_on == true) return  [
      '<p class="instructions">In the task proper, you will not be provided accuracy feedback on your judgements, but the box you selected will be outlined in <font color="blue"><strong>blue</strong></font>.</p>' +
      '<p class="instructions">You will be asked to rate your confidence in your judgement on a rating scale after each trial, which will be explained next.</p>' 

    ]

    if(ratings_on == false) return  [
      '<p class="instructions">In the task proper, you will not be provided accuracy feedback on your judgements, but the box you selected will be outlined in <font color="blue"><strong>blue</strong></font>.</p>' 

    ]
  },
  show_clickable_nav: true
}



var test_start = {
  type: jsPsychInstructions,

  pages:  function(){
   if(ratings_on == true) return  [
    '<p class="instructions">The task proper is divided into '+total_blocks+' blocks of '+no_trials+' trials, where you can pause for a break before every block.</p>' +
    '<p class="instructions">There are no time limits on your responses to the dots or on your confidence ratings.</p>' +
    '<p class="instructions">As a reminder: <br>If the box on the <strong>left</strong> had more dots, press <strong>W</strong>.<br> If the box on the <strong>right</strong> had more dots, press <strong>E</strong>.</p>' 

  ]

  if(ratings_on == false) return  [
    '<p class="instructions">The task proper is divided into '+total_blocks+' blocks of '+no_trials+' trials, where you can pause for a break before every block.</p>' +
    '<p class="instructions">There are no time limits on your responses to the dots.</p>' +
    '<p class="instructions">As a reminder: <br>If the box on the <strong>left</strong> had more dots, press <strong>W</strong>.<br> If the box on the <strong>right</strong> had more dots, press <strong>E</strong>.</p>' 

  ]
},
show_clickable_nav: true
}


  var new_block = {
    type: jsPsychInstructions,
    on_finish: function(){
      blocknum++;
    },
    pages: function(){
      return [
        '<p class="instructions">You can now pause for a break. You have completed ' + blocknum + ' out of '+total_blocks+' blocks.<br><br>As a reminder:<br>If the box on the <strong>left</strong> had more dots, press <strong>W</strong>.<br>If the box on the <strong>right</strong> had more dots, press <strong>E</strong>.</p>' 

        ]
    },
    show_clickable_nav: true
  }




/////////////// **********   STEM  ***************************** ///////////////





question_prompts = [

  {item: "STEM01", question_text: "Wai-Hin and Connie have shared an office for years but Wai-Hin gets a new job and Connie loses contact with her. What action would be the most effective for Connie?", situation: "Wai-Hin and Connie have shared an office for years but Wai-Hin gets a new job and Connie loses contact with her.", answers_text: ["(a) Just accept that she is gone and the friendship is over.", "(b) Ring Wai-Hin and ask her out for lunch or coffee to catch up.", "(c) Contact Wai-Hin and arrange to catch up but also make friends with her replacement.", "(d) Spend time getting to know the other people in the office, and strike up new friendships."]},
  {item: "STEM02", question_text: "Manual is only a few years from retirement when he finds out his position will no longer exist, although he will still have a job with a less prestigious role. What action would be the most effective for Manual?", situation: "Manual is only a few years from retirement when he finds out his position will no longer exist, although he will still have a job with a less prestigious role.",answers_text: ["(a) Carefully consider his options and discuss it with his family.", "(b) Talk to his boss or the management about it.", "(c) Accept the situation, but still feel bitter about it.", "(d) Walk out of that job."]},
  {item: "STEM03", question_text: "Surbhi starts a new job where he doesn&#39;t know anyone and finds that no one is particularly friendly. What action would be the most effective for Surbhi?", situation: "Surbhi starts a new job where he doesn&#39;t know anyone and finds that no one is particularly friendly.", answers_text: ["(a) Have fun with his friends outside of work hours.", "(b) Concentrate on doing his work well at the new job.", "(c) Make an effort to talk to people and be friendly himself.", "(d) Leave the job and find one with a better environment."]},
  {item: "STEM04", question_text: "Andre moves away from the city his friends and family are in. He finds his friends make less effort to keep in contact than he thought they would. What action would be the most effective for Andre?", situation: "Andre moves away from the city his friends and family are in. He finds his friends make less effort to keep in contact than he thought they would.", answers_text: ["(a) Try to adjust to life in the new city by joining clubs and activities there.", "(b) He should make the effort to contact them, but also try to meet people in his new city.", "(c) Let go of his old friends, who have shown themselves to be unreliable.", "(d) Tell his friends he is disappointed in them for not contacting him."]},
  {item: "STEM05", question_text: "Clayton has been overseas for a long time and returns to visit his family. So much has changed that Clayton feels left out. What action would be the most effective for Clayton?", situation: "Clayton has been overseas for a long time and returns to visit his family. So much has changed that Clayton feels left out.", answers_text: ["(a) Nothing - it will sort itself out soon enough.", "(b) Tell his family he feels left out.", "(c) Spend time listening and getting involved again.", "(d) Reflect that relationships can change with time."]},
  {item: "STEM06", question_text: "Daniel has been accepted for a prestigious position in a different country from his family, who he is close to. He and his wife decide it is worth relocating. What action would be the most effective for Daniel?", situation: "Daniel has been accepted for a prestigious position in a different country from his family, who he is close to. He and his wife decide it is worth relocating.", answers_text: ["(a) Realize he shouldn&#39;t have applied for the job if he didn&#39;t want to leave.", "(b) Set up a system for staying in touch, like weekly phone calls or emails.", "(c) Think about the great opportunities this change offers.", "(d) Don&#39;t take the position."]},
  {item: "STEM07", question_text: "Mei Ling answers the phone and hears that close relatives are in hospital critically ill. What action would be the most effective for Mei Ling?", situation: "Mei Ling answers the phone and hears that close relatives are in hospital critically ill.", answers_text: ["(a) Let herself cry and express emotion for as long as she feels like.", "(b) Speak to other family to calm herself and find out what is happening, then visit the hospital.", "(c) There is nothing she can do.", "(d) Visit the hospital and ask staff about their condition."]},
  {item: "STEM08", question_text: "Shona has not spoken to her nephew for months, whereas when he was younger they were very close. She rings him but he can only talk for five minutes. What action would be the most effective for Shona?", situation: "Shona has not spoken to her nephew for months, whereas when he was younger they were very close. She rings him but he can only talk for five minutes.", answers_text: ["(a) Realize that he is growing up and might not want to spend so much time with his family any more.", "(b) Make plans to drop by and visit him in person and have a good chat.", "(c) Understand that relationships change, but keep calling him from time to time.", "(d) Be upset about it, but realize there is nothing she can do."]},
  {item: "STEM09", question_text: "Mina and her sister-in-law normally get along quite well, and the sister-in-law regularly baby-sits for her for a small fee. Lately she has also been cleaning away cobwebs, commenting on the mess, which Mina finds insulting. What action would be the most effective for Mina?", situation: "Mina and her sister-in-law normally get along quite well, and the sister-in-law regularly baby-sits for her for a small fee. Lately she has also been cleaning away cobwebs, commenting on the mess, which Mina finds insulting.", answers_text: ["(a) Tell her sister-in-law these comments upset her.", "(b) Get a new babysitter.", "(c) Be grateful her house is being cleaned for free.", "(d) Tell her only to baby-sit, not to clean."]},
  {item: "attention_check", question_text: "Please select option c for this item to show you are paying attention", situation: "Please select option c for this item to show you are paying attention", answers_text: ["(a) Tell them not to cry.", "(b) Tell them to put on a brave face.", "(c) Help them focus on other things.", "(d) suggest something else for them to do"]},
  {item: "STEM10", question_text: "Juno is fairly sure his company is going down and his job is under threat. It is a large company and nothing official has been said. What action would be the most effective for Juno?", situation: "Juno is fairly sure his company is going down and his job is under threat. It is a large company and nothing official has been said.", answers_text: ["(a) Find out what is happening and discusshis concerns with his family.", "(b) Try to keep the company afloat by working harder.", "(c) Start applying for other jobs.", "(d) Think of these events as an opportunity for a new start."]},
  {item: "STEM11", question_text: "Mallory moves from a small company to a very large one, where there is little personal contact, which she misses. What action would be the most effective for Mallory?", situation: "Mallory moves from a small company to a very large one, where there is little personal contact, which she misses.", answers_text: ["(a) Talk to her workmates, try to create social contacts and make friends.", "(b) Start looking for a new job so she can leave that environment.", "(c) Just give it time, and things will be okay.", "(d) Concentrate on her outside-work friends and colleagues from previous jobs."]},
  {item: "STEM12", question_text: "A demanding client takes up a lot of Jill&#39;s time and then asks to speak to Jill&#39;s boss about her performance. Although Jill&#39;s boss assures her that her performance is fine, Jill feels upset. What action would be the most effective for Jill?", situation: "A demanding client takes up a lot of Jill&#39;s time and then asks to speak to Jill&#39;s boss about her performance. Although Jill&#39;s boss assures her that her performance is fine, Jill feels upset.", answers_text: ["(a) Talk to her friends or workmates about it.", "(b) Ignore the incident and move on to her next task.", "(c) Calm down by taking deep breaths or going for a short walk.", "(d) Think that she has been successful in the past and this client being difficult is not her fault."]},
  {item: "STEM13", question_text: "Blair and Flynn usually go to a cafe after the working week and chat about what&#39;s going on in the company. After Blair&#39;s job is moved to a different section in the company, he stops coming to the cafe. Flynn misses these Friday talks. What action would be the most effective for Flynn?", situation: "Blair and Flynn usually go to a cafe after the working week and chat about what&#39;s going on in the company. After Blair&#39;s job is moved to a different section in the company, he stops coming to the cafe. Flynn misses these Friday talks. ", answers_text: ["(a) Go to the cafe orsocialize with other workers.", "(b) Don&#39;t worry about it, ignore the changes and let Blair be.", "(c) Not talk to Blair again.", "(d) Invite Blair again, maybe rescheduling for another time.",]},
  {item: "STEM14", question_text: "Michelle&#39;s friend Dara is moving overseas to live with her partner. They have been good friends for many years and Dara is unlikely to come back. What action would be the most effective for Michelle?", situation: "Michelle&#39;s friend Dara is moving overseas to live with her partner. They have been good friends for many years and Dara is unlikely to come back.", answers_text: ["(a) Forget about Dara.", "(b) Spend time with other friends,keeping herself busy.", "(c) Think that Dara and her partner will return soon.", "(d) Make sure she keeps in contact through email, phone or letter writing.",]},
  {item: "STEM15", question_text: "Hannah&#39;s access to essential resources has been delayed and her work is way behind schedule. Her progress report makes no mention of the lack of resources. What action would be the most effective for Hannah?", situation: "Hannah&#39;s access to essential resources has been delayed and her work is way behind schedule. Her progress report makes no mention of the lack of resources.", answers_text: ["(a) Explain the lack of resources to her boss or to management.", "(b) Learn that she should plan ahead for next time.", "(c) Document the lack of resources in her progress report.", "(d) Don&#39;t worry about it.",]},
  {item: "STEM16", question_text: "Reece&#39;s friend points out that her young children seem to be developing more quickly than Reece&#39;s. Reece sees that this is true. What action would be the most effective for Reece?", situation: "Reece&#39;s friend points out that her young children seem to be developing more quickly than Reece&#39;s. Reece sees that this is true.", answers_text: ["(a) Talk the issue over with another friend.", "(b) Angrily confront her friend about making such statements.", "(c) Realize that children develop at different rates.", "(d) Talk to a doctor about what the normal rates of development are."]},
  {item: "STEM17", question_text: "Jumah has been working at anew job part-time while he studies. His shift times for the week are changed at the last minute, without consulting him. What action would be the most effective for Jumah?", situation: "Jumah has been working at anew job part-time while he studies. His shift times for the week are changed at the last minute, without consulting him.", answers_text: ["(a) Refuse to work the new shifts.", "(b) Find out if there is some reasonable explanation for the shift changes.", "(c) Tell the manager in charge of shifts that he is not happy about it.", "(d) Grumpily accept the changes and do the shifts."]},
  {item: "STEM18", question_text: "Julie hasn&#39;t seen Ka for ages and looks forward to their weekend trip away. However, Ka has changed a lot and Julie finds that she is no longer an interesting companion. What action would be the most effective for Julie?", situation: "Julie hasn&#39;t seen Ka for ages and looks forward to their weekend trip away. However, Ka has changed a lot and Julie finds that she is no longer an interesting companion.", answers_text: ["(a) Cancel the trip and go home.", "(b) Realize that it is time to give up the friendship and move on.", "(c) Understand that people change, so move on, but remember the good times.", "(d) Concentrate on her other, more rewarding friendships."]}
]




var STEM_trial = {
  data: function(){
    return {trialnum: trialnum, blocknum: blocknum}
  },
  timeline: [


// Question

    {type: jsPsychSurveyMultiChoice,
      questions: [
        {
          prompt: jsPsych.timelineVariable('question_text'), 
          name: jsPsych.timelineVariable('item'), 
          options:  jsPsych.timelineVariable('answers_text'), 
          required: false
        }
      ],
      on_finish: function(data) {

        data.trial_type = "Stimulus Response";
        data.item = jsPsych.timelineVariable('item');


// Pull out selection



        const keys = Object.keys(data.response);
        const firstKey = keys[0];
        const firstValue = data.response[firstKey];




        if(jsPsych.timelineVariable('answers_text')[0] == firstValue) {data.selection = 0}
          if(jsPsych.timelineVariable('answers_text')[1] == firstValue) {data.selection = 1}
            if(jsPsych.timelineVariable('answers_text')[2] == firstValue) {data.selection = 2}
              if(jsPsych.timelineVariable('answers_text')[3] == firstValue) {data.selection = 3}



// Scoring

                data.correct = 0;

              if(jsPsych.timelineVariable('item') == "STEM01" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM01" & data.selection+ 1 == 2) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM01" & data.selection+ 1 == 3) {data.correct =  0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM01" & data.selection+ 1 == 4) {data.correct =  0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM02" & data.selection+ 1 == 1) {data.correct =  0.75};
              if(jsPsych.timelineVariable('item') == "STEM02" & data.selection+ 1 == 2) {data.correct =  0.25};
              if(jsPsych.timelineVariable('item') == "STEM02" & data.selection+ 1 == 3) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM02" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM03" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM03" & data.selection+ 1 == 2) {data.correct =  0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM03" & data.selection+ 1 == 3) {data.correct =  0.833333333};
              if(jsPsych.timelineVariable('item') == "STEM03" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM04" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM04" & data.selection+ 1 == 2) {data.correct =  1};
              if(jsPsych.timelineVariable('item') == "STEM04" & data.selection+ 1 == 3) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM04" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM05" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM05" & data.selection+ 1 == 2) {data.correct =  0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM05" & data.selection+ 1 == 3) {data.correct =  0.75};
              if(jsPsych.timelineVariable('item') == "STEM05" & data.selection+ 1 == 4) {data.correct =  0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM06" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM06" & data.selection+ 1 == 2) {data.correct =  0.833333333};
              if(jsPsych.timelineVariable('item') == "STEM06" & data.selection+ 1 == 3) {data.correct =  0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM06" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM07" & data.selection+ 1 == 1) {data.correct =  0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM07" & data.selection+ 1 == 2) {data.correct =  0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM07" & data.selection+ 1 == 3) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM07" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM08" & data.selection+ 1 == 1) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM08" & data.selection+ 1 == 2) {data.correct =  0.25};
              if(jsPsych.timelineVariable('item') == "STEM08" & data.selection+ 1 == 3) {data.correct =  0.75};
              if(jsPsych.timelineVariable('item') == "STEM08" & data.selection+ 1 == 4) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM09" & data.selection+ 1 == 1) {data.correct =  0.75};
              if(jsPsych.timelineVariable('item') == "STEM09" & data.selection+ 1 == 2) {data.correct =  0};
              if(jsPsych.timelineVariable('item') == "STEM09" & data.selection+ 1 == 3) {data.correct =  0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM09" & data.selection+ 1 == 4) {data.correct =  0.083333333};


              if(jsPsych.timelineVariable('item') == "STEM10" & data.selection + 1 == 1){data.correct = 0.75};
              if(jsPsych.timelineVariable('item') == "STEM10" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM10" & data.selection + 1 == 3){data.correct = 0.25};
              if(jsPsych.timelineVariable('item') == "STEM10" & data.selection + 1 == 4){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM11" & data.selection + 1 == 1){data.correct = 0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM11" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM11" & data.selection + 1 == 3){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM11" & data.selection + 1 == 4){data.correct = 0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM12" & data.selection + 1 == 1){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM12" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM12" & data.selection + 1 == 3){data.correct = 0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM12" & data.selection + 1 == 4){data.correct = 0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM13" & data.selection + 1 == 1){data.correct = 0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM13" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM13" & data.selection + 1 == 3){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM13" & data.selection + 1 == 4){data.correct = 0.833333333};
              if(jsPsych.timelineVariable('item') == "STEM14" & data.selection + 1 == 1){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM14" & data.selection + 1 == 2){data.correct = 0.083333333};
              if(jsPsych.timelineVariable('item') == "STEM14" & data.selection + 1 == 3){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM14" & data.selection + 1 == 4){data.correct = 0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM15" & data.selection + 1 == 1){data.correct = 0.166666667};
              if(jsPsych.timelineVariable('item') == "STEM15" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM15" & data.selection + 1 == 3){data.correct = 0.833333333};
              if(jsPsych.timelineVariable('item') == "STEM15" & data.selection + 1 == 4){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM16" & data.selection + 1 == 1){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM16" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM16" & data.selection + 1 == 3){data.correct = 0.25};
              if(jsPsych.timelineVariable('item') == "STEM16" & data.selection + 1 == 4){data.correct = 0.75};
              if(jsPsych.timelineVariable('item') == "STEM17" & data.selection + 1 == 1){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM17" & data.selection + 1 == 2){data.correct = 0.75};
              if(jsPsych.timelineVariable('item') == "STEM17" & data.selection + 1 == 3){data.correct = 0.25};
              if(jsPsych.timelineVariable('item') == "STEM17" & data.selection + 1 == 4){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM18" & data.selection + 1 == 1){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM18" & data.selection + 1 == 2){data.correct = 0};
              if(jsPsych.timelineVariable('item') == "STEM18" & data.selection + 1 == 3){data.correct = 0.916666667};
              if(jsPsych.timelineVariable('item') == "STEM18" & data.selection + 1 == 4){data.correct = 0.083333333};









            },
          },





// Confidence Rating
          {
            timeline: [

              {
                type: jsPsychHtmlSliderResponse,
                stimulus: "<h3>Rate your confidence:</h3>" +
                '<div id = "conf1" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px; margin-left: 15px;"></div>' +
                '<div id = "conf2" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 169px;"></div>' +
                '<div id = "conf3" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 323px;"></div>' +
                '<div id = "conf4" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 477px;"></div>' +
                '<div id = "conf5" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 631px;"></div>',
                min: 1,
                max: 6,
                step: 1,
                slider_width: 800,
                require_movement: true,
                labels: ['Guessing', "", "", "", "", "Certain"],
                button_label: "Submit",
                on_finish: function(data){
                  data.trial_type = "Confidence Rating";

                },
                css_classes: ["conf_rating"]

              }

            ],
            conditional_function: function(){
              if(ratings_on === false){
                return false;
              } else {
                return false;
              }
            }
          },


// Summary trial to store all the data typically required (nothing is displayed to the particpant) and do the staircasing
          {
            type: jsPsychCallFunction,
            func: function(data){


            },
            on_finish: function(data){

              data.rt = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].rt;
              data.response = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].response;
              data.correct = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].correct;


              data.confidence = "NA";


              data.trial_type = "Summary Trial"
              trialnum++;

            }
          },
        ],
        timeline_variables: question_prompts
      };





      const stem_test_block = {
        data: {phase: "STEM Test"},
        timeline: [STEM_trial],
        on_timeline_start: function(){
          provide_feedback = false; 
        }
      }



/////////////// **********   Dot Discrimination  ***************************** ///////////////




      var dot_trial = {
        data: function(){
          return {trialnum: trialnum, blocknum: blocknum}
        },
        timeline: [

// Check Fullscreen
          {
            timeline: [

              {type: jsPsychFullscreen,
                message: '<p>You need to be in fullscreen mode to continue the experiment! <br></br> Please click the button below to enter fullscreen mode.<br></br><p>',
                fullscreen_mode: true,
                on_finish: function(){
                  in_fullscreen = true;
                }
              }
            ],
            conditional_function: function(){
              if(in_fullscreen === true){
                return false;
              } else {
                return true;
              }
            }
          },

// Fixation
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p id = "fixation" style = "position: absolute; font-size: 70px">+</p>',
            on_load: function(){

        // Set X position
              var w = window.innerWidth;
              var element = document.getElementById('fixation');
              var positionInfo = element.getBoundingClientRect();
              var width = positionInfo.width;

              element.style.left = (w-width)/2+'px';

        // Set Y position
              var h = window.innerHeight;
              var x = ((h-795)/2) + 35;


              element.style.top = x +'px';
            },
            choices: 'NO_KEYS',
            trial_duration: 1000,
            on_finish: function(data){
              data.trial_type = "Fixation";
            }
          },



// Presentation
          {
            type: jsPsychCanvasKeyboardResponse,
            trial_duration: 300,
            canvas_size: [788, 790],
            stimulus: function(c){

              if(staircase_on == true){ drawStim(c, Math.round(Math.exp(dots_diff)), jsPsych.timelineVariable('target_left')) }
                if(staircase_on == false){ 

          // Vary difficulty between 1 and 70 dots
                  if(random_diff == true){
                    var list = [];
                    for (var i = 1; i <= 70; i++) {
                      list.push(i);
                    }
                    dots_diff = jsPsych.randomization.sampleWithReplacement(list, 1);  

                    drawStim(c, Math.round(dots_diff), jsPsych.timelineVariable('target_left')) 

                  }

          // Fix difficulty at the starting value
                  if(random_diff == false){
                    drawStim(c, Math.round(dots_diff), jsPsych.timelineVariable('target_left')) 

                  }



                }

              },
              choices: "NO_KEYS",
              on_finish: function(data){
                data.trial_type = "Stimulus Presentation";
                data.stimdevi = dots_diff;
              }
            },



// Response
            {
              type: jsPsychCanvasKeyboardResponse,
              canvas_size: [788, 790],
              stimulus: function(c){
                drawBlank(c, "black", "black")
              },
              choices: ['e','w'],
              prompt: function(){
                if(provide_feedback == true) {return '<p id = "prompt" style="position: absolute; max-width: 800px; top: 48%; left: 28%; font-size: 24px">Press W if the box on the left had more dots. Press E if the box on the right had more dots.</p>'} else {return ''}
              },
              on_load: function(){
               if(provide_feedback == true) {
                var w = window.innerWidth;
                var element = document.getElementById('prompt');
                var positionInfo = element.getBoundingClientRect();
                var width = positionInfo.width;

                element.style.left = (w-width)/2+'px';
              }
            },
            on_finish: function(data){
      //Scoring
              data.correct = 0;
              if(jsPsych.timelineVariable('target_left') == 1 & data.response == 'w') {data.correct = 1;}
              if(jsPsych.timelineVariable('target_left') == 0 & data.response == 'e') {data.correct = 1;}

              data.trial_type = "Stimulus Response"
            }
          },



// Response Highlight
          {
            timeline:[{
              type: jsPsychCanvasKeyboardResponse,
              trial_duration: 500,
              canvas_size: [788, 790],
              stimulus: function(c){

                var last_trial_response = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].response;
                if(last_trial_response == "e") return drawBlank(c, "transparent", "blue")
                  if(last_trial_response == "w") return drawBlank(c, "blue", "transparent")
                },
              choices: "NO_KEYS",
              on_finish: function(data){
                data.trial_type = "Response Highlight";

              }
            }],
            conditional_function: function(){
              if(provide_feedback === true){
                return false;
              } else {
                return true;
              }
            }
          },


// Confidence Rating
          {
            timeline: [

              {
                type: jsPsychHtmlSliderResponse,
                stimulus: "<h3>Rate your confidence:</h3>" +
                '<div id = "conf1" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px; margin-left: 15px;"></div>' +
                '<div id = "conf2" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 169px;"></div>' +
                '<div id = "conf3" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 323px;"></div>' +
                '<div id = "conf4" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 477px;"></div>' +
                '<div id = "conf5" class = "conf" style = "height: 25px; width: 154px; margin-top: 2px;margin-left: 631px;"></div>',
                min: 1,
                max: 6,
                step: 1,
                slider_width: 800,
                require_movement: true,
                labels: ['Guessing', "", "", "", "", "Certain"],
                button_label: "Submit",
                on_finish: function(data){
                  data.trial_type = "Confidence Rating";

                },
                css_classes: ["conf_rating"]

              }

            ],
            conditional_function: function(){
              if(provide_feedback === true | ratings_on === false){
                return false;
              } else {
                return true;
              }
            }
          },

// Provide Feedback 
          {
            timeline: [

              {type: jsPsychCanvasKeyboardResponse,
                trial_duration: 500,
                canvas_size: [788, 790],
                stimulus: function(c){

                  var last_trial_response = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].response;
                  var last_trial_correct = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].correct;


                  if(last_trial_correct == 1){col = "green"} else{col = "red"}

                    if(last_trial_response == "e") return drawBlank(c, "transparent", col)
                      if(last_trial_response == "w") return drawBlank(c, col, "transparent")
                    },

                  choices: "NO_KEYS",
                  prompt: function(data){
                   var last_trial_correct = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].correct;
                   if(last_trial_correct == 1){return '<p id = "prompt" style="position: absolute; max-width: 800px; top: 48%; left: 28%; font-size: 24px">Correct</p>'} else {return '<p id = "prompt" style="position: absolute; max-width: 800px; top: 48%; left: 28%; font-size: 24px">Incorrect</p>'}
                 },
                 on_load: function(){

                  var w = window.innerWidth;
                  var element = document.getElementById('prompt');
                  var positionInfo = element.getBoundingClientRect();
                  var width = positionInfo.width;

                  element.style.left = (w-width)/2+'px';
                },
                on_finish: function(data){
                  data.trial_type = "Feedback";

                }
              }
            ],
            conditional_function: function(){
              if(provide_feedback === true){
                return true;
              } else {
                return false;
              }
            }
          },



// Summary trial to store all the data typically required (nothing is displayed to the particpant) and do the staircasing
          {
            type: jsPsychCallFunction,
            func: function(data){

              accuracy = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).select('correct').values;
              accuracy = accuracy.slice(Math.max(accuracy.length - 2, 0))

              if(staircase_on == true){
                stairs = staircase(dots_diff, accuracy, trialnum);

                dots_diff = stairs.diff;

              }

            },
            on_finish: function(data){
              data.rt = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].rt;
              data.phase = phase;
              data.response = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].response;
              data.correct = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last().values()[0].correct;
              data.target_left = jsPsych.timelineVariable('target_left');
              if(provide_feedback == false & ratings_on == true){
                data.confidence = jsPsych.data.get().filter({trial_type: "Confidence Rating"}).last().values()[0].response;
                data.feedback = "False";
              } else {
                data.feedback = "True";
              }
              if(staircase_on == true) data.stimdevi = Math.round(Math.exp(jsPsych.data.get().filter({trial_type: "Stimulus Presentation"}).last().values()[0].stimdevi));
              if(staircase_on == false) data.stimdevi = jsPsych.data.get().filter({trial_type: "Stimulus Presentation"}).last().values()[0].stimdevi;
              data.trial_type = "Summary Trial"
              trialnum++;

            }
          },



        ],
        timeline_variables: [
          {target_left: 1},
          {target_left: 0},
        ],
        randomize_order: true
      };





      const dot_practice_block = {
        timeline: [dot_trial],
        repetitions: no_practice_trials/2,
        on_timeline_start: function(){
          provide_feedback = true; 
          phase = "Practice";
        }
      }


      const dot_test_block = {
        timeline: [dot_trial],
        repetitions: no_trials/2,
        on_timeline_start: function(){
          provide_feedback = false; 
          phase = "DD Test";
        }
      }






/////////////// **********   SAVE DATA  ***************************** ///////////////

// Capture any url paramaters
      const PROLIFIC_PID = jsPsych.data.getURLVariable('PROLIFIC_PID');
      const SONAID = jsPsych.data.getURLVariable('SONAID');
      const pilot = jsPsych.data.getURLVariable('pilot');


// Redirect based on SONA vs Prolific

    // SONA
      if(typeof SONAID != 'undefined'){

        jsPsych.data.addProperties({participant_id: SONAID});
        jsPsych.data.addProperties({Source: "SONA"});

        redirect_link = "https://sydneypsych.sona-systems.com/webstudy_credit.aspx?experiment_id="+sona_experiment_id+"&credit_token="+sona_credit_token+"&survey_code=" + SONAID + "&id=" + SONAID;
    attention_redirect_link = "https://sydney.au1.qualtrics.com/jfe/form/SV_3h2qh8pBAnv00QK?SONAID=" + SONAID + "accuracy=" + jsPsych.data.get().filter({trial_type: "Summary Trial"}).select('correct').mean(); // A seperate link for those who fail the attention check


  }

    // PROLIFIC
  if(typeof SONAID === 'undefined'){

    jsPsych.data.addProperties({participant_id: PROLIFIC_PID});
    jsPsych.data.addProperties({Source: "Prolific"});

    redirect_link ="https://app.prolific.com/submissions/complete?cc=" + Prolific_redirect;
    attention_redirect_link ="https://app.prolific.co/submissions/complete?cc=" + Prolific_failed_check; // A seperate link for those who fail the attention check
  }




  // Save to OSF
  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;



  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: DataPipe_ID,
    filename: filename,
    data_string: ()=>jsPsych.data.get().csv()
  };




/////////////// **********   Timeline  ***************************** ///////////////

  condition_1_timeline = [ browser_check, enter_fullscreen, participant_info_paid, participant_info_SONA, stem_instructions, stem_test_block,  dd_instructions, dot_practice_block, practice_end, conf_instruc, test_start, dot_test_block, new_block, dot_test_block, new_block, dot_test_block, debug, save_data, DEBRIEF_SONA];

  condition_2_timeline = [ browser_check, enter_fullscreen, participant_info_paid, participant_info_SONA,  dd_instructions, dot_practice_block, practice_end, conf_instruc, test_start, dot_test_block, new_block, dot_test_block, new_block, dot_test_block, stem_instructions, stem_test_block, debug, save_data, DEBRIEF_SONA];


  async function createExperiment(){
    const condition = await jsPsychPipe.getCondition(DataPipe_ID);
    jsPsych.data.addProperties({order: condition});

    if(condition == 0) { timeline = condition_1_timeline; }
    if(condition == 1) { timeline = condition_2_timeline; }
    jsPsych.run(timeline);
  }




  createExperiment();


</script>
</html>
